// MediaClassifier GUI - Main Window
// ä½¿ç”¨ Slint æ„å»ºçš„åª’ä½“æ–‡ä»¶åˆ†ç±»å·¥å…·å›¾å½¢ç•Œé¢
// æ”¯æŒ i18nï¼ˆä½¿ç”¨ @tr() å®ï¼‰ã€ä¸»é¢˜åˆ‡æ¢ã€å¤šé¡µé¢å¯¼èˆª

import {
    Button,
    LineEdit,
    ListView,
    VerticalBox,
    HorizontalBox,
    GroupBox,
    CheckBox,
    ProgressIndicator,
    ScrollView,
    Palette,
    ComboBox,
} from "std-widgets.slint";

// ============================================================================
// æ•°æ®ç»“æ„å®šä¹‰
// ============================================================================

// åˆ†ç±»è§„åˆ™çš„æ•°æ®ç»“æ„
export struct RuleItem {
    id: int,
    name: string,
    description: string,
    extensions: string,
    directory_template: string,
    min_size: string,
    max_size: string,
    enabled: bool,
}

// ç»Ÿè®¡ä¿¡æ¯
export struct Statistics {
    total: int,
    success: int,
    skipped: int,
    renamed: int,
    failed: int,
}

// åº”ç”¨çŠ¶æ€æšä¸¾
export enum AppState {
    Idle,
    Working,
    Completed,
}

// é¡µé¢æšä¸¾
export enum PageType {
    Main,
    Config,
}

// ä¸»é¢˜æšä¸¾
export enum ThemeMode {
    Auto,
    Light,
    Dark,
}

// ============================================================================
// ä¸»çª—å£ç»„ä»¶
// ============================================================================
export component MainWindow inherits Window {
    title: "MediaClassifier";
    icon: @image-url("../../../assets/icon.svg");
    // Task 4: åº”ç”¨å°ºå¯¸ç¼©å°ä¸€äº›
    min-width: 700px;
    min-height: 600px;
    preferred-width: 750px;
    preferred-height: 650px;
    background: Palette.background;

    // ========================================================================
    // å±æ€§
    // ========================================================================
    
    // ä¸»é¢˜
    in-out property <ThemeMode> theme_mode: ThemeMode.Auto;
    
    // å·¥ä½œç›®å½•
    in-out property <string> working_directory: "";
    
    // åº”ç”¨çŠ¶æ€
    in-out property <AppState> app_state: AppState.Idle;
    in-out property <float> progress: 0.0;
    
    // æ—¥å¿—å†…å®¹
    in-out property <string> log_content: "";
    in-out property <bool> show_log: false;
    
    // ç»Ÿè®¡ä¿¡æ¯
    in-out property <Statistics> stats: { total: 0, success: 0, skipped: 0, renamed: 0, failed: 0 };
    in-out property <bool> show_stats_popup: false;
    
    // é…ç½®è§„åˆ™åˆ—è¡¨
    in-out property <[RuleItem]> rules: [];
    
    // å½“å‰é¡µé¢
    in-out property <PageType> current_page: PageType.Main;
    
    // æ·»åŠ /ç¼–è¾‘è§„åˆ™å¼¹çª—
    in-out property <bool> show_add_rule_popup: false;
    in-out property <bool> is_editing_rule: false;
    in-out property <int> editing_rule_id: -1;
    in-out property <string> new_rule_name: "";
    in-out property <string> new_rule_desc: "";
    in-out property <string> new_rule_ext: "";
    in-out property <string> new_rule_template: "";
    in-out property <string> new_rule_min_size: "";
    in-out property <string> new_rule_max_size: "";
    in-out property <bool> new_rule_enabled: true;
    
    // å±è”½æ–‡ä»¶å¤¹ç®¡ç†
    in-out property <bool> show_exclude_popup: false;
    in-out property <[string]> exclude_folders: [];
    in-out property <string> new_exclude_folder: "";
    
    // å…³äºåº”ç”¨
    in-out property <bool> show_about_popup: false;
    
    // Task 3: æèµ å¼¹çª—æ§åˆ¶
    in-out property <bool> show_donate_popup: false;

    // ========================================================================
    // å›è°ƒ
    // ========================================================================
    callback browse_directory();
    callback start_work();
    callback toggle_log();
    callback close_stats_popup();
    callback go_to_config();
    callback go_to_main();
    callback add_rule();
    callback edit_rule(int);
    callback save_new_rule();
    callback cancel_add_rule();
    callback delete_rule(int);
    callback manage_exclude_folders();
    callback add_exclude_folder();
    callback remove_exclude_folder(int);
    callback browse_exclude_folder();
    callback show_about();
    callback change_theme(ThemeMode);
    // Task 2: æ·»åŠ æ‰“å¼€ GitHub é“¾æ¥çš„å›è°ƒ
    callback open_github();
    
    // å½“ä¸»é¢˜æ”¹å˜æ—¶æ›´æ–° Palette
    changed theme_mode => {
        if (self.theme_mode == ThemeMode.Light) {
            Palette.color-scheme = ColorScheme.light;
        } else if (self.theme_mode == ThemeMode.Dark) {
            Palette.color-scheme = ColorScheme.dark;
        } else {
            Palette.color-scheme = ColorScheme.unknown;
        }
    }

    // ========================================================================
    // ä¸»å¸ƒå±€
    // ========================================================================
    VerticalBox {
        padding: 0px;
        spacing: 0px;

        // é¡¶éƒ¨å¯¼èˆªæ 
        Rectangle {
            height: 56px;
            background: Palette.background.darker(0.05);
            HorizontalBox {
                padding-left: 16px;
                padding-right: 16px;
                spacing: 12px;
                
                // åº”ç”¨æ ‡é¢˜ - ä½¿ç”¨ @tr() å®
                Text {
                    text: @tr("ğŸ¬ MediaClassifier");
                    font-size: 18px;
                    font-weight: 600;
                    color: Palette.foreground;
                    vertical-alignment: center;
                }

                Rectangle {
                    horizontal-stretch: 1;
                }
                
                // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
                Button {
                    text: theme_mode == ThemeMode.Light ? "â˜€ï¸" : (theme_mode == ThemeMode.Dark ? "ğŸŒ™" : "ğŸ”†");
                    width: 40px;
                    height: 40px;
                    clicked => {
                        if theme_mode == ThemeMode.Auto {
                            change_theme(ThemeMode.Light);
                        } else if theme_mode == ThemeMode.Light {
                            change_theme(ThemeMode.Dark);
                        } else {
                            change_theme(ThemeMode.Auto);
                        }
                    }
                }
                
                // å…³äºæŒ‰é’®
                Button {
                    text: "â„¹ï¸";
                    width: 40px;
                    height: 40px;
                    clicked => {
                        show_about();
                    }
                }
                
                // ä»…å›¾æ ‡å¯¼èˆªæŒ‰é’®
                Button {
                    text: current_page == PageType.Main ? "âš™ï¸" : "ğŸ ";
                    width: 40px;
                    height: 40px;
                    clicked => {
                        if current_page == PageType.Main {
                            go_to_config();
                        } else {
                            go_to_main();
                        }
                    }
                }
            }
        }

        // é¡µé¢å†…å®¹åŒºåŸŸ
        Rectangle {
            vertical-stretch: 1;
            background: Palette.background;
            
            // ä¸»é¡µé¢
            if current_page == PageType.Main: VerticalBox {
                padding: 20px;
                spacing: 16px;
                alignment: center;
                
                // å±…ä¸­å®¹å™¨
                VerticalBox {
                    max-width: 500px;
                    spacing: 16px;
                    
                    // ç›®å½•é€‰æ‹©è¾“å…¥æ¡†
                    Rectangle {
                        height: 48px;
                        border-radius: 8px;
                        border-width: 1px;
                        border-color: Palette.border;
                        background: Palette.background;
                        
                        // ä½¿ç”¨ Rectangle + TouchArea åŒ…è£¹ LineEdit å®ç°ç‚¹å‡»
                        Rectangle {
                            VerticalBox {
                                padding: 8px;
                                dir-input := LineEdit {
                                    text <=> working_directory;
                                    placeholder-text: @tr("ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹...");
                                    enabled: app_state == AppState.Idle;
                                }
                            }
                            
                            // TouchArea è¦†ç›–åœ¨ LineEdit ä¸Šæ–¹ï¼Œæ•è·ç‚¹å‡»äº‹ä»¶
                            TouchArea {
                                width: 100%;
                                height: 100%;
                                clicked => {
                                    if app_state == AppState.Idle {
                                        browse_directory();
                                    }
                                }
                            }
                        }
                    }
                    
                    // å¼€å§‹æŒ‰é’®
                    Button {
                        text: working_directory == "" ? @tr("é€‰æ‹©å·¥ä½œç›®å½•") : app_state == AppState.Working ? @tr("â³ å¤„ç†ä¸­...") : @tr("å¼€å§‹å·¥ä½œ");
                        primary: working_directory != "";
                        enabled: app_state == AppState.Idle && working_directory != "";
                        height: 48px;
                        clicked => {
                            start_work();
                        }
                    }
                    
                    // è¿›åº¦åŒºåŸŸï¼ˆä»…åœ¨å·¥ä½œæ—¶æ˜¾ç¤ºï¼‰
                    if app_state == AppState.Working: VerticalBox {
                        spacing: 12px;
                        HorizontalBox {
                            Text {
                                text: @tr("å¤„ç†è¿›åº¦");
                                font-weight: 500;
                                color: Palette.foreground;
                                vertical-alignment: center;
                            }

                            Rectangle {
                                horizontal-stretch: 1;
                            }

                            Text {
                                text: "\{Math.round(progress * 100)}%";
                                color: Palette.foreground;
                                vertical-alignment: center;
                            }
                        }

                        ProgressIndicator {
                            progress: progress;
                            height: 8px;
                        }
                        
                        // è¯¦æƒ…æŒ‰é’®
                        Button {
                            text: show_log ? @tr("éšè—è¯¦æƒ…") : @tr("æ˜¾ç¤ºè¯¦æƒ…");
                            clicked => {
                                toggle_log();
                            }
                        }
                    }
                    
                    // æ—¥å¿—åŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰
                    if show_log && app_state == AppState.Working: Rectangle {
                        height: 250px;
                        border-radius: 8px;
                        border-width: 1px;
                        border-color: Palette.border;
                        background: Palette.background.darker(0.02);
                        log-scroll := ScrollView {
                            viewport-y: min(0px, self.visible-height - self.viewport-height);
                            VerticalBox {
                                padding: 12px;
                                Text {
                                    text: log_content;
                                    font-family: "monospace";
                                    font-size: 12px;
                                    color: Palette.foreground;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }
                }
            }
            
            // é…ç½®é¡µé¢
            if current_page == PageType.Config: VerticalBox {
                padding: 20px;
                spacing: 16px;
                
                // é…ç½®é¡µé¢æ ‡é¢˜å’ŒæŒ‰é’®
                HorizontalBox {
                    spacing: 12px;
                    Text {
                        text: @tr("âš™ï¸ é…ç½®ç®¡ç†");
                        font-size: 18px;
                        font-weight: 600;
                        color: Palette.foreground;
                        vertical-alignment: center;
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: @tr("ğŸš« å±è”½æ–‡ä»¶å¤¹");
                        clicked => {
                            manage_exclude_folders();
                        }
                    }

                    Button {
                        text: @tr("â• æ–°å¢è§„åˆ™");
                        primary: true;
                        clicked => {
                            add_rule();
                        }
                    }
                }
                
                // è§„åˆ™è¡¨æ ¼
                Rectangle {
                    vertical-stretch: 1;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: Palette.border;
                    VerticalBox {
                        padding: 0px;
                        spacing: 0px;
                        
                        // è¡¨å¤´
                        Rectangle {
                            height: 36px;
                            background: Palette.background.darker(0.05);
                            HorizontalBox {
                                padding-left: 12px;
                                padding-right: 12px;
                                spacing: 8px;
                                Text {
                                    text: @tr("è§„åˆ™åç§°");
                                    font-weight: 600;
                                    width: 120px;
                                    vertical-alignment: center;
                                }

                                Text {
                                    text: @tr("æ–‡ä»¶æ‰©å±•å");
                                    font-weight: 600;
                                    width: 100px;
                                    vertical-alignment: center;
                                }

                                Text {
                                    text: @tr("ç›®å½•æ¨¡æ¿");
                                    font-weight: 600;
                                    horizontal-stretch: 1;
                                    vertical-alignment: center;
                                }

                                Text {
                                    text: @tr("å¯ç”¨");
                                    font-weight: 600;
                                    width: 60px;
                                    vertical-alignment: center;
                                }

                                Text {
                                    text: "";
                                    width: 100px;
                                }
                            }
                        }
                        
                        // è§„åˆ™åˆ—è¡¨
                        ScrollView {
                            vertical-stretch: 1;
                            VerticalBox {
                                padding: 0px;
                                spacing: 0px;
                                for rule[idx] in rules: Rectangle {
                                    height: 40px;
                                    background: Math.mod(idx, 2) == 0 ? Palette.background : Palette.background.darker(0.02);
                                    HorizontalBox {
                                        padding-left: 12px;
                                        padding-right: 12px;
                                        spacing: 8px;
                                        Text {
                                            text: rule.name;
                                            width: 120px;
                                            vertical-alignment: center;
                                            overflow: elide;
                                        }

                                        Text {
                                            text: rule.extensions;
                                            width: 100px;
                                            vertical-alignment: center;
                                            overflow: elide;
                                        }

                                        Text {
                                            text: rule.directory_template;
                                            horizontal-stretch: 1;
                                            vertical-alignment: center;
                                            overflow: elide;
                                        }

                                        Text {
                                            text: rule.enabled ? "on" : "off";
                                            width: 60px;
                                            vertical-alignment: center;
                                            horizontal-alignment: center;
                                            color: rule.enabled ? #4caf50 : #f44336;
                                        }

                                        HorizontalBox {
                                            width: 100px;
                                            spacing: 8px;
                                            alignment: center;
                                            Rectangle {
                                                width: 28px;
                                                height: 28px;
                                                border-radius: 4px;
                                                background: touch-edit.has-hover ? Palette.accent-background : transparent;
                                                Text {
                                                    text: "âœï¸";
                                                    font-size: 16px;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: center;
                                                }

                                                touch-edit := TouchArea {
                                                    clicked => {
                                                        edit_rule(rule.id);
                                                    }
                                                }
                                            }

                                            Rectangle {
                                                width: 28px;
                                                height: 28px;
                                                border-radius: 4px;
                                                background: touch-delete.has-hover ? Palette.accent-background : transparent;
                                                Text {
                                                    text: "ğŸ—‘ï¸";
                                                    font-size: 16px;
                                                    vertical-alignment: center;
                                                    horizontal-alignment: center;
                                                }

                                                touch-delete := TouchArea {
                                                    clicked => {
                                                        delete_rule(rule.id);
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    // ========================================================================
    // ç»Ÿè®¡ç»“æœå¼¹çª—
    // ========================================================================
    if show_stats_popup: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 360px;
            height: 280px;
            border-radius: 12px;
            background: Palette.background;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;
            VerticalBox {
                padding: 20px;
                spacing: 12px;
                Text {
                    text: @tr("ğŸ“Š å¤„ç†å®Œæˆ");
                    font-size: 18px;
                    font-weight: 600;
                    horizontal-alignment: center;
                }

                Rectangle {
                    height: 1px;
                    background: Palette.border;
                }
                
                // ç»Ÿè®¡é¡¹
                VerticalBox {
                    spacing: 10px;
                    HorizontalBox {
                        Text {
                            text: @tr("æ€»è®¡") + ":";
                            horizontal-stretch: 1;
                        }

                        Text {
                            text: "\{stats.total}";
                            font-weight: 600;
                        }
                    }

                    HorizontalBox {
                        Text {
                            text: @tr("âœ… æˆåŠŸ") + ":";
                            horizontal-stretch: 1;
                        }

                        Text {
                            text: "\{stats.success}";
                            font-weight: 600;
                            color: #4caf50;
                        }
                    }

                    HorizontalBox {
                        Text {
                            text: @tr("ğŸ”„ é‡å‘½å") + ":";
                            horizontal-stretch: 1;
                        }

                        Text {
                            text: "\{stats.renamed}";
                            font-weight: 600;
                            color: #2196f3;
                        }
                    }

                    HorizontalBox {
                        Text {
                            text: @tr("â­ï¸ è·³è¿‡") + ":";
                            horizontal-stretch: 1;
                        }

                        Text {
                            text: "\{stats.skipped}";
                            font-weight: 600;
                            color: #ff9800;
                        }
                    }

                    HorizontalBox {
                        Text {
                            text: @tr("âŒ å¤±è´¥") + ":";
                            horizontal-stretch: 1;
                        }

                        Text {
                            text: "\{stats.failed}";
                            font-weight: 600;
                            color: #f44336;
                        }
                    }
                }

                Rectangle {
                    vertical-stretch: 1;
                }

                Button {
                    text: @tr("å…³é—­");
                    primary: true;
                    horizontal-stretch: 1;
                    clicked => {
                        close_stats_popup();
                    }
                }
            }
        }
    }

    // ========================================================================
    // æ–°å¢è§„åˆ™å¼¹çª—
    // ========================================================================
    if show_add_rule_popup: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 450px;
            height: 560px;
            border-radius: 12px;
            background: Palette.background;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;
            VerticalBox {
                padding: 20px;
                spacing: 12px;
                Text {
                    text: is_editing_rule ? @tr("ç¼–è¾‘è§„åˆ™") : @tr("â• æ–°å¢è§„åˆ™");
                    font-size: 16px;
                    font-weight: 600;
                }

                Rectangle {
                    height: 1px;
                    background: Palette.border;
                }
                
                // è¡¨å•å­—æ®µ
                VerticalBox {
                    spacing: 10px;
                    HorizontalBox {
                        spacing: 8px;
                        Text {
                            text: @tr("è§„åˆ™åç§°") + ":";
                            width: 90px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text <=> new_rule_name;
                            horizontal-stretch: 1;
                        }
                    }

                    HorizontalBox {
                        spacing: 8px;
                        Text {
                            text: @tr("è§„åˆ™æè¿°") + ":";
                            width: 90px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text <=> new_rule_desc;
                            horizontal-stretch: 1;
                        }
                    }

                    HorizontalBox {
                        spacing: 8px;
                        Text {
                            text: @tr("æ–‡ä»¶æ‰©å±•å") + ":";
                            width: 90px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text <=> new_rule_ext;
                            placeholder-text: "jpg,png,gif";
                            horizontal-stretch: 1;
                        }
                    }

                    HorizontalBox {
                        spacing: 8px;
                        Text {
                            text: @tr("ç›®å½•æ¨¡æ¿") + ":";
                            width: 90px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text <=> new_rule_template;
                            placeholder-text: "{{ext}}/{{date}}";
                            horizontal-stretch: 1;
                        }
                    }

                    HorizontalBox {
                        spacing: 8px;
                        Text {
                            text: @tr("æœ€å°å¤§å°") + ":";
                            width: 90px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text <=> new_rule_min_size;
                            placeholder-text: "0B";
                            horizontal-stretch: 1;
                        }
                    }

                    HorizontalBox {
                        spacing: 8px;
                        Text {
                            text: @tr("æœ€å¤§å¤§å°") + ":";
                            width: 90px;
                            vertical-alignment: center;
                        }

                        LineEdit {
                            text <=> new_rule_max_size;
                            placeholder-text: @tr("æ— é™åˆ¶");
                            horizontal-stretch: 1;
                        }
                    }

                    HorizontalBox {
                        spacing: 8px;
                        Text {
                            text: @tr("å¯ç”¨") + ":";
                            width: 90px;
                            vertical-alignment: center;
                        }

                        CheckBox {
                            checked <=> new_rule_enabled;
                        }
                    }
                }
                
                // æŒ‰é’®åŒº
                HorizontalBox {
                    spacing: 12px;

                    Button {
                        height: 48px;
                        text: @tr("å–æ¶ˆ");
                        visible: true;
                        clicked => {
                            cancel_add_rule();
                        }
                    }

                    Button {
                        text: @tr("ä¿å­˜");
                        height: 48px;
                        primary: true;
                        clicked => {
                            save_new_rule();
                        }
                    }
                }
            }
        }
    }

    // ========================================================================
    // å±è”½æ–‡ä»¶å¤¹ç®¡ç†å¼¹çª—
    // ========================================================================
    if show_exclude_popup: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 450px;
            height: 400px;
            border-radius: 12px;
            background: Palette.background;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;
            VerticalBox {
                padding: 20px;
                spacing: 12px;
                Text {
                    text: @tr("ğŸš« å±è”½æ–‡ä»¶å¤¹ç®¡ç†");
                    font-size: 16px;
                    font-weight: 600;
                }

                Rectangle {
                    height: 1px;
                    background: Palette.border;
                }
                
                // æ·»åŠ æ–‡ä»¶å¤¹è¾“å…¥åŒºåŸŸ
                HorizontalBox {
                    spacing: 8px;
                    LineEdit {
                        text <=> new_exclude_folder;
                        placeholder-text: @tr("è¾“å…¥æ–‡ä»¶å¤¹åç§°ï¼ˆå¦‚ï¼š.git, node_modulesï¼‰");
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: @tr("æ·»åŠ ");
                        primary: true;
                        clicked => {
                            add_exclude_folder();
                        }
                    }

                    Button {
                        text: "ğŸ“";
                        clicked => {
                            browse_exclude_folder();
                        }
                    }
                }
                
                // å·²æ·»åŠ çš„æ–‡ä»¶å¤¹åˆ—è¡¨ï¼ˆæ ‡ç­¾æ ·å¼ï¼‰
                ScrollView {
                    vertical-stretch: 1;
                    VerticalBox {
                        spacing: 6px;
                        padding: 6px;
                        for folder[index] in exclude_folders: Rectangle {
                            height: 32px;
                            border-radius: 6px;
                            background: Palette.accent-background;
                            HorizontalBox {
                                padding-left: 12px;
                                padding-right: 12px;
                                spacing: 8px;
                                Text {
                                    text: folder;
                                    vertical-alignment: center;
                                    horizontal-stretch: 1;
                                }

                                Rectangle {
                                    width: 28px;
                                    height: 28px;
                                    border-radius: 4px;
                                    background: touch-delete-folder.has-hover ? Palette.accent-background.darker(0.1) : transparent;
                                    Text {
                                        text: "ğŸ—‘ï¸";
                                        font-size: 16px;
                                        vertical-alignment: center;
                                        horizontal-alignment: center;
                                    }

                                    touch-delete-folder := TouchArea {
                                        clicked => {
                                            remove_exclude_folder(index);
                                        }
                                    }
                                }
                            }
                        }
                        if exclude_folders.length == 0: Text {
                            text: @tr("æš‚æ— å±è”½æ–‡ä»¶å¤¹");
                            color: Palette.foreground.transparentize(0.5);
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
                
                // æŒ‰é’®åŒº
                HorizontalBox {
                    spacing: 12px;
                    Rectangle {
                        horizontal-stretch: 1;
                    }

                    Button {
                        text: @tr("å…³é—­");
                        primary: true;
                        clicked => {
                            show_exclude_popup = false;
                        }
                    }
                }
            }
        }
    }

    // ========================================================================
    // å…³äºåº”ç”¨å¼¹çª— - Task 2 & 3: æ·»åŠ  GitHub é“¾æ¥, éšè— Alipay, æ·»åŠ æèµ æŒ‰é’®
    // ========================================================================
    if show_about_popup: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 400px;
            border-radius: 12px;
            background: Palette.background;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;
            VerticalBox {
                padding: 20px;
                spacing: 16px;
                
                // æ ‡é¢˜
                Text {
                    text: @tr("ğŸï¸ å…³äº MediaClassifier");
                    font-size: 18px;
                    font-weight: 700;
                    horizontal-alignment: center;
                }

                Rectangle {
                    height: 1px;
                    background: Palette.border;
                }
                
                // åº”ç”¨å›¾æ ‡
                Rectangle {
                    height: 60px;
                    HorizontalBox {
                        alignment: center;
                        Text {
                            text: "ğŸ¬";
                            font-size: 48px;
                        }
                    }
                }
                
                // ç‰ˆæœ¬ä¿¡æ¯
                Text {
                    text: @tr("ç‰ˆæœ¬ï¼šv1.3.0");
                    font-size: 13px;
                    horizontal-alignment: center;
                    color: Palette.foreground.transparentize(0.3);
                }
                
                // åº”ç”¨æè¿°
                Text {
                    text: @tr("ä¸€æ¬¾åŸºäºè§„åˆ™çš„åª’ä½“æ–‡ä»¶è‡ªåŠ¨åˆ†ç±»å·¥å…·ï¼Œæ”¯æŒè‡ªå®šä¹‰ç›®å½•æ¨¡æ¿ã€æ–‡ä»¶å¤§å°è¿‡æ»¤ç­‰åŠŸèƒ½ã€‚");
                    font-size: 13px;
                    horizontal-alignment: center;
                    wrap: word-wrap;
                }
                
                // ä½œè€…ä¿¡æ¯
                Text {
                    text: @tr("ä½œè€…ï¼šZander");
                    font-size: 13px;
                    horizontal-alignment: center;
                }
                
                // Task 2: GitHub é“¾æ¥æŒ‰é’®
                Button {
                    text: @tr("ğŸ”— GitHub");
                    horizontal-stretch: 1;
                    clicked => {
                        open_github();
                    }
                }

                Rectangle {
                    height: 1px;
                    background: Palette.border;
                }
                
                // Task 3: æèµ æŒ‰é’®ï¼ˆæ›¿ä»£ç›´æ¥æ˜¾ç¤ºæ”¯ä»˜å®äºŒç»´ç ï¼‰
                Button {
                    text: @tr("ğŸ’ æ”¯æŒä½œè€…");
                    horizontal-stretch: 1;
                    clicked => {
                        show_donate_popup = true;
                    }
                }
                
                // å…³é—­æŒ‰é’®
                Button {
                    text: @tr("å…³é—­");
                    primary: true;
                    clicked => {
                        show_about_popup = false;
                    }
                }
            }
        }
    }
    
    // ========================================================================
    // Task 3: æèµ å¼¹çª— - æ˜¾ç¤ºæ”¯ä»˜å®äºŒç»´ç 
    // ========================================================================
    if show_donate_popup: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 300px;
            border-radius: 12px;
            background: Palette.background;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;
            VerticalBox {
                padding: 20px;
                spacing: 16px;
                
                // æ ‡é¢˜
                Text {
                    text: @tr("ğŸ’ æ”¯æŒä½œè€…");
                    font-size: 16px;
                    font-weight: 600;
                    horizontal-alignment: center;
                }
                
                // æç¤ºä¿¡æ¯
                Text {
                    text: @tr("å¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªå·¥å…·æœ‰ç”¨ï¼Œæ¬¢è¿æ”¯æŒï¼š");
                    font-size: 12px;
                    horizontal-alignment: center;
                    color: Palette.foreground.transparentize(0.3);
                }
                
                // æ”¯ä»˜å®äºŒç»´ç 
                Image {
                    source: @image-url("../../../assets/alipay.jpg");
                    width: 100%;
                    // height: 300px;
                    horizontal-alignment: center;
                    image-fit: contain;
                }
                
                // å…³é—­æŒ‰é’®
                Button {
                    text: @tr("å…³é—­");
                    primary: true;
                    width: 100%;
                    height: 48px;
                    clicked => {
                        show_donate_popup = false;
                    }
                }
            }
        }
    }
}
