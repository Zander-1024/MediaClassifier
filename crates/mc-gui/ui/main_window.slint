// MediaClassifier GUI - Main Window
// ä½¿ç”¨ Slint æ„å»ºçš„åª’ä½“æ–‡ä»¶åˆ†ç±»å·¥å…·å›¾å½¢ç•Œé¢
// æ”¯æŒ i18nã€ä¸»é¢˜åˆ‡æ¢ã€å¤šé¡µé¢å¯¼èˆª

import { Button, LineEdit, ListView, VerticalBox, HorizontalBox, GroupBox, CheckBox, ProgressIndicator, ScrollView, Palette, ComboBox } from "std-widgets.slint";

// ============================================================================
// æ•°æ®ç»“æ„å®šä¹‰
// ============================================================================

// åˆ†ç±»è§„åˆ™çš„æ•°æ®ç»“æ„
export struct RuleItem {
    id: int,
    name: string,
    description: string,
    extensions: string,
    directory_template: string,
    min_size: string,
    max_size: string,
    enabled: bool,
}

// ç»Ÿè®¡ä¿¡æ¯
export struct Statistics {
    total: int,
    success: int,
    skipped: int,
    renamed: int,
    failed: int,
}

// åº”ç”¨çŠ¶æ€æšä¸¾
export enum AppState {
    Idle,
    Working,
    Completed,
}

// é¡µé¢æšä¸¾
export enum PageType {
    Main,
    Config,
}

// ä¸»é¢˜æšä¸¾
export enum ThemeMode {
    Auto,
    Light,
    Dark,
}

// ============================================================================
// i18n å­—ç¬¦ä¸²ç»“æ„
// ============================================================================
export struct I18nStrings {
    // é€šç”¨
    app_title: string,
    // ä¸»é¡µé¢
    working_directory: string,
    select_directory: string,
    start_working: string,
    show_details: string,
    hide_details: string,
    // è¿›åº¦
    progress_label: string,
    // æ—¥å¿—æ¶ˆæ¯
    log_error_dir_not_exist: string,
    log_scanning: string,
    log_processing: string,
    // ç»Ÿè®¡å¼¹çª—
    stats_title: string,
    stats_total: string,
    stats_success: string,
    stats_renamed: string,
    stats_skipped: string,
    stats_failed: string,
    stats_close: string,
    // é…ç½®é¡µé¢
    config_title: string,
    config_add: string,
    config_back: string,
    config_rule_name: string,
    config_rule_desc: string,
    config_rule_ext: string,
    config_rule_template: string,
    config_rule_min_size: string,
    config_rule_max_size: string,
    config_rule_enabled: string,
    config_save: string,
    config_cancel: string,
    // å¯¼èˆª
    nav_config: string,
    nav_main: string,
    // ä¸»é¢˜
    theme_auto: string,
    theme_light: string,
    theme_dark: string,
    // è¯­è¨€
    lang_zh: string,
    lang_en: string,
}

// ============================================================================
// ä¸»çª—å£ç»„ä»¶
// ============================================================================
export component MainWindow inherits Window {
    title: "MediaClassifier";
    min-width: 800px;
    min-height: 600px;
    preferred-width: 900px;
    preferred-height: 700px;
    background: Palette.background;

    // ========================================================================
    // å±æ€§
    // ========================================================================
    
    // å·¥ä½œç›®å½•
    in-out property <string> working_directory: "";
    
    // åº”ç”¨çŠ¶æ€
    in-out property <AppState> app_state: AppState.Idle;
    in-out property <float> progress: 0.0;
    
    // æ—¥å¿—å†…å®¹
    in-out property <string> log_content: "";
    in-out property <bool> show_log: false;
    
    // ç»Ÿè®¡ä¿¡æ¯
    in-out property <Statistics> stats: { total: 0, success: 0, skipped: 0, renamed: 0, failed: 0 };
    in-out property <bool> show_stats_popup: false;
    
    // é…ç½®è§„åˆ™åˆ—è¡¨
    in-out property <[RuleItem]> rules: [];
    
    // å½“å‰é¡µé¢
    in-out property <PageType> current_page: PageType.Main;
    
    // æ·»åŠ è§„åˆ™å¼¹çª—
    in-out property <bool> show_add_rule_popup: false;
    in-out property <string> new_rule_name: "";
    in-out property <string> new_rule_desc: "";
    in-out property <string> new_rule_ext: "";
    in-out property <string> new_rule_template: "";
    in-out property <string> new_rule_min_size: "";
    in-out property <string> new_rule_max_size: "";
    in-out property <bool> new_rule_enabled: true;
    
    // ä¸»é¢˜
    in-out property <ThemeMode> theme_mode: ThemeMode.Auto;
    
    // å½“å‰è¯­è¨€
    in-out property <string> current_language: "zh";
    
    // i18n å­—ç¬¦ä¸²
    in-out property <I18nStrings> i18n: {
        app_title: "ğŸ¬ MediaClassifier",
        working_directory: "å·¥ä½œç›®å½•",
        select_directory: "é€‰æ‹©å·¥ä½œç›®å½•",
        start_working: "å¼€å§‹å·¥ä½œ",
        show_details: "æ˜¾ç¤ºè¯¦æƒ…",
        hide_details: "éšè—è¯¦æƒ…",
        progress_label: "å¤„ç†è¿›åº¦",
        log_error_dir_not_exist: "âŒ é”™è¯¯: ç›®å½•ä¸å­˜åœ¨",
        log_scanning: "ğŸ” å¼€å§‹æ‰«ææ–‡ä»¶...",
        log_processing: "ğŸ“ å¤„ç†:",
        stats_title: "ğŸ“Š å¤„ç†å®Œæˆ",
        stats_total: "æ€»è®¡",
        stats_success: "æˆåŠŸ",
        stats_renamed: "é‡å‘½å",
        stats_skipped: "è·³è¿‡",
        stats_failed: "å¤±è´¥",
        stats_close: "å…³é—­",
        config_title: "âš™ï¸ é…ç½®ç®¡ç†",
        config_add: "â• æ–°å¢è§„åˆ™",
        config_back: "â† è¿”å›ä¸»é¡µ",
        config_rule_name: "è§„åˆ™åç§°",
        config_rule_desc: "è§„åˆ™æè¿°",
        config_rule_ext: "æ–‡ä»¶æ‰©å±•å",
        config_rule_template: "ç›®å½•æ¨¡æ¿",
        config_rule_min_size: "æœ€å°å¤§å°",
        config_rule_max_size: "æœ€å¤§å¤§å°",
        config_rule_enabled: "å¯ç”¨",
        config_save: "ä¿å­˜",
        config_cancel: "å–æ¶ˆ",
        nav_config: "âš™ï¸ é…ç½®",
        nav_main: "ğŸ  ä¸»é¡µ",
        theme_auto: "è‡ªåŠ¨",
        theme_light: "æµ…è‰²",
        theme_dark: "æ·±è‰²",
        lang_zh: "ä¸­æ–‡",
        lang_en: "EN",
    };

    // ========================================================================
    // å›è°ƒ
    // ========================================================================
    callback browse_directory();
    callback start_work();
    callback toggle_log();
    callback close_stats_popup();
    callback go_to_config();
    callback go_to_main();
    callback add_rule();
    callback save_new_rule();
    callback cancel_add_rule();
    callback delete_rule(int);
    callback change_theme(ThemeMode);
    callback change_language(string);

    // ========================================================================
    // ä¸»å¸ƒå±€
    // ========================================================================
    VerticalBox {
        padding: 0px;
        spacing: 0px;

        // é¡¶éƒ¨å¯¼èˆªæ 
        Rectangle {
            height: 48px;
            background: Palette.background.darker(0.05);
            
            HorizontalBox {
                padding-left: 16px;
                padding-right: 16px;
                spacing: 12px;
                
                // åº”ç”¨æ ‡é¢˜
                Text {
                    text: i18n.app_title;
                    font-size: 18px;
                    font-weight: 600;
                    color: Palette.foreground;
                    vertical-alignment: center;
                }
                
                Rectangle { horizontal-stretch: 1; }
                
                // è¯­è¨€åˆ‡æ¢
                HorizontalBox {
                    spacing: 4px;
                    
                    Button {
                        text: i18n.lang_zh;
                        checkable: true;
                        checked: current_language == "zh";
                        clicked => { change_language("zh"); }
                    }
                    Button {
                        text: i18n.lang_en;
                        checkable: true;
                        checked: current_language == "en";
                        clicked => { change_language("en"); }
                    }
                }
                
                // ä¸»é¢˜é€‰æ‹©
                HorizontalBox {
                    spacing: 4px;
                    
                    Button {
                        text: i18n.theme_auto;
                        checkable: true;
                        checked: theme_mode == ThemeMode.Auto;
                        clicked => { change_theme(ThemeMode.Auto); }
                    }
                    Button {
                        text: "â˜€ï¸";
                        checkable: true;
                        checked: theme_mode == ThemeMode.Light;
                        clicked => { change_theme(ThemeMode.Light); }
                    }
                    Button {
                        text: "ğŸŒ™";
                        checkable: true;
                        checked: theme_mode == ThemeMode.Dark;
                        clicked => { change_theme(ThemeMode.Dark); }
                    }
                }
                
                // é¡µé¢åˆ‡æ¢æŒ‰é’®
                Button {
                    text: current_page == PageType.Main ? i18n.nav_config : i18n.nav_main;
                    clicked => {
                        if current_page == PageType.Main {
                            go_to_config();
                        } else {
                            go_to_main();
                        }
                    }
                }
            }
        }

        // é¡µé¢å†…å®¹åŒºåŸŸ
        Rectangle {
            vertical-stretch: 1;
            background: Palette.background;
            
            // ä¸»é¡µé¢
            if current_page == PageType.Main: VerticalBox {
                padding: 24px;
                spacing: 20px;
                
                // å·¥ä½œç›®å½•æ ‡é¢˜
                Text {
                    text: i18n.working_directory;
                    font-size: 20px;
                    font-weight: 600;
                    color: Palette.foreground;
                }
                
                // ç›®å½•é€‰æ‹©è¾“å…¥æ¡†
                Rectangle {
                    height: 48px;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: Palette.border;
                    background: Palette.background;
                    
                    HorizontalBox {
                        padding: 8px;
                        spacing: 8px;
                        
                        dir-input := LineEdit {
                            text <=> working_directory;
                            placeholder-text: "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹...";
                            horizontal-stretch: 1;
                            enabled: app_state == AppState.Idle;
                        }
                        
                        Button {
                            text: "ğŸ“";
                            width: 48px;
                            enabled: app_state == AppState.Idle;
                            clicked => { browse_directory(); }
                        }
                    }
                }
                
                // å¼€å§‹æŒ‰é’®
                Button {
                    text: working_directory == "" ? i18n.select_directory : 
                          app_state == AppState.Working ? "â³ å¤„ç†ä¸­..." : i18n.start_working;
                    primary: working_directory != "";
                    enabled: app_state == AppState.Idle && working_directory != "";
                    height: 48px;
                    clicked => { start_work(); }
                }
                
                // è¿›åº¦åŒºåŸŸï¼ˆä»…åœ¨å·¥ä½œæ—¶æ˜¾ç¤ºï¼‰
                if app_state == AppState.Working: VerticalBox {
                    spacing: 12px;
                    
                    HorizontalBox {
                        Text {
                            text: i18n.progress_label;
                            font-weight: 500;
                            color: Palette.foreground;
                            vertical-alignment: center;
                        }
                        Rectangle { horizontal-stretch: 1; }
                        Text {
                            text: "\{Math.round(progress * 100)}%";
                            color: Palette.foreground;
                            vertical-alignment: center;
                        }
                    }
                    
                    ProgressIndicator {
                        progress: progress;
                        height: 8px;
                    }
                    
                    // è¯¦æƒ…æŒ‰é’®
                    Button {
                        text: show_log ? i18n.hide_details : i18n.show_details;
                        clicked => { toggle_log(); }
                    }
                }
                
                // æ—¥å¿—åŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰
                if show_log && app_state == AppState.Working: Rectangle {
                    vertical-stretch: 1;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: Palette.border;
                    background: Palette.background.darker(0.02);
                    
                    ScrollView {
                        VerticalBox {
                            padding: 12px;
                            
                            Text {
                                text: log_content;
                                font-family: "monospace";
                                font-size: 12px;
                                color: Palette.foreground;
                                wrap: word-wrap;
                            }
                        }
                    }
                }
                
                // å ä½ç©ºé—´
                if !show_log || app_state != AppState.Working: Rectangle {
                    vertical-stretch: 1;
                }
            }
            
            // é…ç½®é¡µé¢
            if current_page == PageType.Config: VerticalBox {
                padding: 24px;
                spacing: 20px;
                
                // é…ç½®é¡µé¢æ ‡é¢˜å’ŒæŒ‰é’®
                HorizontalBox {
                    spacing: 12px;
                    
                    Text {
                        text: i18n.config_title;
                        font-size: 20px;
                        font-weight: 600;
                        color: Palette.foreground;
                        vertical-alignment: center;
                    }
                    
                    Rectangle { horizontal-stretch: 1; }
                    
                    Button {
                        text: i18n.config_add;
                        primary: true;
                        clicked => { add_rule(); }
                    }
                }
                
                // è§„åˆ™è¡¨æ ¼
                Rectangle {
                    vertical-stretch: 1;
                    border-radius: 8px;
                    border-width: 1px;
                    border-color: Palette.border;
                    
                    VerticalBox {
                        padding: 0px;
                        spacing: 0px;
                        
                        // è¡¨å¤´
                        Rectangle {
                            height: 40px;
                            background: Palette.background.darker(0.05);
                            
                            HorizontalBox {
                                padding-left: 12px;
                                padding-right: 12px;
                                spacing: 8px;
                                
                                Text { text: i18n.config_rule_name; font-weight: 600; width: 120px; vertical-alignment: center; }
                                Text { text: i18n.config_rule_ext; font-weight: 600; width: 100px; vertical-alignment: center; }
                                Text { text: i18n.config_rule_template; font-weight: 600; horizontal-stretch: 1; vertical-alignment: center; }
                                Text { text: i18n.config_rule_enabled; font-weight: 600; width: 60px; vertical-alignment: center; }
                                Text { text: ""; width: 60px; }
                            }
                        }
                        
                        // è§„åˆ™åˆ—è¡¨
                        ScrollView {
                            vertical-stretch: 1;
                            
                            VerticalBox {
                                padding: 0px;
                                spacing: 0px;
                                
                                for rule[idx] in rules: Rectangle {
                                    height: 44px;
                                    background: Math.mod(idx, 2) == 0 ? Palette.background : Palette.background.darker(0.02);
                                    
                                    HorizontalBox {
                                        padding-left: 12px;
                                        padding-right: 12px;
                                        spacing: 8px;
                                        
                                        Text { text: rule.name; width: 120px; vertical-alignment: center; overflow: elide; }
                                        Text { text: rule.extensions; width: 100px; vertical-alignment: center; overflow: elide; }
                                        Text { text: rule.directory_template; horizontal-stretch: 1; vertical-alignment: center; overflow: elide; }
                                        Text { 
                                            text: rule.enabled ? "âœ“" : "âœ—"; 
                                            width: 60px; 
                                            vertical-alignment: center;
                                            horizontal-alignment: center;
                                            color: rule.enabled ? #4caf50 : #f44336;
                                        }
                                        Button {
                                            text: "ğŸ—‘ï¸";
                                            width: 40px;
                                            clicked => { delete_rule(rule.id); }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    // ========================================================================
    // ç»Ÿè®¡ç»“æœå¼¹çª—
    // ========================================================================
    if show_stats_popup: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;
        
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 400px;
            height: 320px;
            border-radius: 12px;
            background: Palette.background;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;
            
            VerticalBox {
                padding: 24px;
                spacing: 16px;
                
                Text {
                    text: i18n.stats_title;
                    font-size: 20px;
                    font-weight: 600;
                    horizontal-alignment: center;
                }
                
                Rectangle { height: 1px; background: Palette.border; }
                
                // ç»Ÿè®¡é¡¹
                VerticalBox {
                    spacing: 12px;
                    
                    HorizontalBox {
                        Text { text: i18n.stats_total + ":"; horizontal-stretch: 1; }
                        Text { text: "\{stats.total}"; font-weight: 600; }
                    }
                    HorizontalBox {
                        Text { text: "âœ… " + i18n.stats_success + ":"; horizontal-stretch: 1; }
                        Text { text: "\{stats.success}"; font-weight: 600; color: #4caf50; }
                    }
                    HorizontalBox {
                        Text { text: "ğŸ”„ " + i18n.stats_renamed + ":"; horizontal-stretch: 1; }
                        Text { text: "\{stats.renamed}"; font-weight: 600; color: #2196f3; }
                    }
                    HorizontalBox {
                        Text { text: "â­ï¸ " + i18n.stats_skipped + ":"; horizontal-stretch: 1; }
                        Text { text: "\{stats.skipped}"; font-weight: 600; color: #ff9800; }
                    }
                    HorizontalBox {
                        Text { text: "âŒ " + i18n.stats_failed + ":"; horizontal-stretch: 1; }
                        Text { text: "\{stats.failed}"; font-weight: 600; color: #f44336; }
                    }
                }
                
                Rectangle { vertical-stretch: 1; }
                
                Button {
                    text: i18n.stats_close;
                    primary: true;
                    horizontal-stretch: 1;
                    clicked => { close_stats_popup(); }
                }
            }
        }
    }

    // ========================================================================
    // æ–°å¢è§„åˆ™å¼¹çª—
    // ========================================================================
    if show_add_rule_popup: Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: #00000080;
        
        Rectangle {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            width: 500px;
            height: 480px;
            border-radius: 12px;
            background: Palette.background;
            drop-shadow-blur: 20px;
            drop-shadow-color: #00000040;
            
            VerticalBox {
                padding: 24px;
                spacing: 16px;
                
                Text {
                    text: i18n.config_add;
                    font-size: 18px;
                    font-weight: 600;
                }
                
                Rectangle { height: 1px; background: Palette.border; }
                
                // è¡¨å•å­—æ®µ
                VerticalBox {
                    spacing: 12px;
                    
                    HorizontalBox {
                        spacing: 8px;
                        Text { text: i18n.config_rule_name + ":"; width: 100px; vertical-alignment: center; }
                        LineEdit { text <=> new_rule_name; horizontal-stretch: 1; }
                    }
                    HorizontalBox {
                        spacing: 8px;
                        Text { text: i18n.config_rule_desc + ":"; width: 100px; vertical-alignment: center; }
                        LineEdit { text <=> new_rule_desc; horizontal-stretch: 1; }
                    }
                    HorizontalBox {
                        spacing: 8px;
                        Text { text: i18n.config_rule_ext + ":"; width: 100px; vertical-alignment: center; }
                        LineEdit { text <=> new_rule_ext; placeholder-text: "jpg,png,gif"; horizontal-stretch: 1; }
                    }
                    HorizontalBox {
                        spacing: 8px;
                        Text { text: i18n.config_rule_template + ":"; width: 100px; vertical-alignment: center; }
                        LineEdit { text <=> new_rule_template; placeholder-text: "{ext}/{date}"; horizontal-stretch: 1; }
                    }
                    HorizontalBox {
                        spacing: 8px;
                        Text { text: i18n.config_rule_min_size + ":"; width: 100px; vertical-alignment: center; }
                        LineEdit { text <=> new_rule_min_size; placeholder-text: "0B"; horizontal-stretch: 1; }
                    }
                    HorizontalBox {
                        spacing: 8px;
                        Text { text: i18n.config_rule_max_size + ":"; width: 100px; vertical-alignment: center; }
                        LineEdit { text <=> new_rule_max_size; placeholder-text: "æ— é™åˆ¶"; horizontal-stretch: 1; }
                    }
                    HorizontalBox {
                        spacing: 8px;
                        Text { text: i18n.config_rule_enabled + ":"; width: 100px; vertical-alignment: center; }
                        CheckBox { checked <=> new_rule_enabled; }
                    }
                }
                
                Rectangle { vertical-stretch: 1; }
                
                // æŒ‰é’®åŒº
                HorizontalBox {
                    spacing: 12px;
                    
                    Rectangle { horizontal-stretch: 1; }
                    
                    Button {
                        text: i18n.config_cancel;
                        clicked => { cancel_add_rule(); }
                    }
                    Button {
                        text: i18n.config_save;
                        primary: true;
                        clicked => { save_new_rule(); }
                    }
                }
            }
        }
    }
}
