// MediaClassifier GUI - Main Window
// ä½¿ç”¨ Slint æ„å»ºçš„åª’ä½“æ–‡ä»¶åˆ†ç±»å·¥å…·å›¾å½¢ç•Œé¢

import { Button, LineEdit, ListView, StandardListView, VerticalBox, HorizontalBox, GroupBox, CheckBox, ProgressIndicator, ComboBox, Palette } from "std-widgets.slint";

// åª’ä½“æ–‡ä»¶é¡¹çš„æ•°æ®ç»“æ„
export struct MediaFileItem {
    name: string,
    path: string,
    file_type: string,
    size: string,
    date: string,
    status: string,
}

// åˆ†ç±»è§„åˆ™çš„æ•°æ®ç»“æ„
export struct RuleItem {
    name: string,
    description: string,
    extensions: string,
    enabled: bool,
}

// ç»Ÿè®¡ä¿¡æ¯
export struct Statistics {
    total: int,
    success: int,
    skipped: int,
    renamed: int,
    failed: int,
}

// åº”ç”¨çŠ¶æ€æšä¸¾
export enum AppState {
    Idle,
    Scanning,
    Processing,
    Completed,
}

// ä¸»çª—å£ç»„ä»¶
export component MainWindow inherits Window {
    title: "MediaClassifier";
    min-width: 800px;
    min-height: 600px;
    preferred-width: 1024px;
    preferred-height: 768px;
    background: Palette.background;

    // å±æ€§
    in-out property <string> working_directory: ".";
    in-out property <string> config_path: "~/.config/media-classifier/config.yaml";
    in-out property <[MediaFileItem]> media_files: [];
    in-out property <[RuleItem]> rules: [];
    in-out property <Statistics> stats: { total: 0, success: 0, skipped: 0, renamed: 0, failed: 0 };
    in-out property <AppState> app_state: AppState.Idle;
    in-out property <float> progress: 0.0;
    in-out property <string> status_message: "å°±ç»ª";
    in-out property <bool> clean_empty_dirs: true;

    // å›è°ƒ
    callback browse_directory();
    callback browse_config();
    callback scan_files();
    callback start_classification();
    callback stop_classification();
    callback show_config();
    callback reload_config();

    VerticalBox {
        padding: 16px;
        spacing: 12px;

        // æ ‡é¢˜æ 
        HorizontalBox {
            alignment: center;
            Text {
                text: "ğŸ¬ MediaClassifier";
                font-size: 24px;
                font-weight: 700;
                color: Palette.foreground;
            }
        }

        // ç›®å½•é€‰æ‹©åŒºåŸŸ
        GroupBox {
            title: "ğŸ“ ç›®å½•è®¾ç½®";

            VerticalBox {
                spacing: 8px;

                HorizontalBox {
                    spacing: 8px;
                    Text {
                        text: "å·¥ä½œç›®å½•:";
                        vertical-alignment: center;
                        width: 80px;
                    }
                    dir-input := LineEdit {
                        text <=> working_directory;
                        placeholder-text: "é€‰æ‹©è¦å¤„ç†çš„ç›®å½•...";
                        horizontal-stretch: 1;
                    }
                    Button {
                        text: "æµè§ˆ...";
                        clicked => { browse_directory(); }
                    }
                }

                HorizontalBox {
                    spacing: 8px;
                    Text {
                        text: "é…ç½®æ–‡ä»¶:";
                        vertical-alignment: center;
                        width: 80px;
                    }
                    config-input := LineEdit {
                        text <=> config_path;
                        placeholder-text: "é€‰æ‹©é…ç½®æ–‡ä»¶...";
                        horizontal-stretch: 1;
                    }
                    Button {
                        text: "æµè§ˆ...";
                        clicked => { browse_config(); }
                    }
                    Button {
                        text: "æŸ¥çœ‹";
                        clicked => { show_config(); }
                    }
                }
            }
        }

        // æ“ä½œåŒºåŸŸ
        HorizontalBox {
            spacing: 12px;
            alignment: center;

            Button {
                text: app_state == AppState.Scanning ? "æ‰«æä¸­..." : "ğŸ” æ‰«ææ–‡ä»¶";
                enabled: app_state == AppState.Idle || app_state == AppState.Completed;
                clicked => { scan_files(); }
            }

            Button {
                text: app_state == AppState.Processing ? "å¤„ç†ä¸­..." : "â–¶ï¸ å¼€å§‹åˆ†ç±»";
                enabled: app_state == AppState.Idle && media_files.length > 0;
                primary: true;
                clicked => { start_classification(); }
            }

            Button {
                text: "â¹ï¸ åœæ­¢";
                enabled: app_state == AppState.Scanning || app_state == AppState.Processing;
                clicked => { stop_classification(); }
            }

            CheckBox {
                text: "å¤„ç†åæ¸…ç†ç©ºç›®å½•";
                checked <=> clean_empty_dirs;
            }
        }

        // è¿›åº¦æ¡
        if app_state == AppState.Scanning || app_state == AppState.Processing: HorizontalBox {
            spacing: 8px;
            ProgressIndicator {
                progress: progress;
                horizontal-stretch: 1;
            }
            Text {
                text: "\{Math.round(progress * 100)}%";
                vertical-alignment: center;
            }
        }

        // æ–‡ä»¶åˆ—è¡¨åŒºåŸŸ
        GroupBox {
            title: "ğŸ“‹ åª’ä½“æ–‡ä»¶åˆ—è¡¨ (\{media_files.length} ä¸ªæ–‡ä»¶)";
            vertical-stretch: 1;

            file-list := ListView {
                for item in media_files: Rectangle {
                    height: 32px;
                    background: Palette.background;
                    
                    HorizontalBox {
                        spacing: 8px;
                        padding-left: 8px;
                        padding-right: 8px;
                        
                        Text {
                            text: item.name;
                            vertical-alignment: center;
                            horizontal-stretch: 2;
                        }
                        Text {
                            text: item.file_type;
                            vertical-alignment: center;
                            width: 60px;
                        }
                        Text {
                            text: item.size;
                            vertical-alignment: center;
                            width: 80px;
                        }
                        Text {
                            text: item.status;
                            vertical-alignment: center;
                            width: 100px;
                            color: item.status == "æˆåŠŸ" ? #4caf50 : 
                                   item.status == "å¤±è´¥" ? #f44336 : 
                                   Palette.foreground;
                        }
                    }
                }
            }
        }

        // ç»Ÿè®¡åŒºåŸŸ
        GroupBox {
            title: "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯";

            HorizontalBox {
                spacing: 16px;
                alignment: center;

                HorizontalBox {
                    spacing: 4px;
                    Text { text: "ğŸ“Š æ€»è®¡:"; font-weight: 500; }
                    Text { text: "\{stats.total}"; color: Palette.foreground; }
                }
                HorizontalBox {
                    spacing: 4px;
                    Text { text: "âœ… æˆåŠŸ:"; font-weight: 500; }
                    Text { text: "\{stats.success}"; color: #4caf50; }
                }
                HorizontalBox {
                    spacing: 4px;
                    Text { text: "ğŸ”„ é‡å‘½å:"; font-weight: 500; }
                    Text { text: "\{stats.renamed}"; color: #2196f3; }
                }
                HorizontalBox {
                    spacing: 4px;
                    Text { text: "â­ï¸ è·³è¿‡:"; font-weight: 500; }
                    Text { text: "\{stats.skipped}"; color: #ff9800; }
                }
                HorizontalBox {
                    spacing: 4px;
                    Text { text: "âŒ å¤±è´¥:"; font-weight: 500; }
                    Text { text: "\{stats.failed}"; color: #f44336; }
                }
            }
        }

        // çŠ¶æ€æ 
        HorizontalBox {
            spacing: 8px;
            Rectangle {
                width: 8px;
                height: 8px;
                border-radius: 4px;
                background: app_state == AppState.Idle ? #4caf50 :
                           app_state == AppState.Scanning ? #2196f3 :
                           app_state == AppState.Processing ? #ff9800 :
                           #4caf50;
            }
            Text {
                text: status_message;
                color: Palette.foreground;
                horizontal-stretch: 1;
            }
        }
    }
}
